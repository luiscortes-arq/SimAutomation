<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purga - Sim Automation</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="../recursos/estilos/variables.css">
    <link rel="stylesheet" href="../recursos/estilos/base.css">
    <link rel="stylesheet" href="../recursos/estilos/componentes/contenedores.css">
    <link rel="stylesheet" href="../recursos/estilos/componentes/herramientas-botones.css">
    <link rel="stylesheet" href="../recursos/estilos/fondos.css">
    <link rel="stylesheet" href="../recursos/estilos/animaciones.css">
</head>
<body class="fondo-purga anim-fade-in">
    
    <input type="file" id="fileInput" accept=".udatasmith,.xml" style="display: none;" onchange="handleFileSelect(this)">

    <div class="grupo-accion anim-fade-in-up delay-100">
        <button class="btn btn-verde btn-grande" onclick="document.getElementById('fileInput').click()">
            <span>EXAMINAR</span>
            <div class="btn-icono-circulo">
                <i data-lucide="chevrons-right"></i>
            </div>
        </button>
        <div class="titulo-con-numero">
            <span class="num-resaltado" id="numCount">00</span>
            <span class="texto-titulo">ARCHIVOS</span>
        </div>
        <div id="fileName" style="font-size: 0.7rem; color: var(--texto-secundario); margin-top: 5px; opacity: 0.8;"></div>
    </div>

    <div class="grupo-accion anim-fade-in-up delay-200">
        <button class="btn btn-verde btn-grande" onclick="procesarPurga()">
            <span>IR</span>
            <div class="btn-icono-circulo">
                <i data-lucide="download"></i>
            </div>
        </button>
        <div class="titulo-con-numero">
            <span class="texto-titulo" style="font-weight: 800;">LISTO</span>
            <span class="texto-titulo" style="font-weight: 400;">PARA DESCARGA</span>
        </div>
    </div>

    <div class="grupo-accion anim-fade-in-up delay-300">
        <button class="btn btn-outline" onclick="irALog()">LOG</button>
    </div>

    <!-- Scripts de LÃ³gica -->
    <script src="../recursos/scripts/logica/sort-purge.js"></script>

    <script>
        lucide.createIcons();
        
        let selectedFile = null;

        function handleFileSelect(input) {
            if (input.files && input.files.length > 0) {
                selectedFile = input.files[0];
                document.getElementById('numCount').textContent = '01';
                document.getElementById('fileName').textContent = selectedFile.name;
            }
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        function downloadText(text, filename) {
            const blob = new Blob([text], { type: "application/xml;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function procesarPurga() {
            if (!selectedFile) {
                alert("Por favor selecciona un archivo primero.");
                return;
            }

            try {
                const originalXml = await readFileAsText(selectedFile);
                const processedXml = window.DatasmithSort.sortAndPurgeUdatasmith(originalXml);

                // Guardar datos para el Log
                sessionStorage.setItem('LOG_DATA_ORIGINAL', originalXml);
                sessionStorage.setItem('LOG_DATA_PROCESSED', processedXml);

                // Descargar archivo
                const outName = "TSP_" + selectedFile.name;
                downloadText(processedXml, outName);

                // Navegar al Log
                irALog();

            } catch (e) {
                console.error(e);
                alert("Error al procesar: " + e.message);
            }
        }

        window.addEventListener('message', (event) => {
            if (event.data.tipo === 'CAMBIO_TEMA') {
                if (event.data.tema === 'claro') {
                    document.body.classList.add('tema-claro');
                } else {
                    document.body.classList.remove('tema-claro');
                }
            }
        });

        function irALog() {
            window.parent.postMessage({ tipo: 'NAVEGAR', ruta: 'log.html?origen=purga' }, '*');
        }
    </script>
</body>
</html>
