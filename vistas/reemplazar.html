<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reemplazar - Sim Automation</title>

    <!-- Librería de iconos -->
    <!-- NOTE FOR DUMMIES: Se usa para dibujar iconos SVG (flechas, play, check, etc). -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Estilos globales -->
    <!-- NOTE FOR DUMMIES: Nada de aquí afecta la lógica. Todo es UI. -->
    <link rel="stylesheet" href="../recursos/estilos/tokens.css" />
    <link rel="stylesheet" href="../recursos/estilos/base.css" />
    <link
      rel="stylesheet"
      href="../recursos/estilos/componentes/contenedores.css"
    />
    <link
      rel="stylesheet"
      href="../recursos/estilos/componentes/herramientas-botones.css"
    />
    <link rel="stylesheet" href="../recursos/estilos/fondos.css" />
    <link rel="stylesheet" href="../recursos/estilos/animaciones.css" />
  </head>

  <body class="fondo-reemplazar anim-fade-in">
    <!-- ************************************************************************************************ -->
    <!-- CONTENEDOR PRINCIPAL -->
    <!-- ************************************************************************************************ -->
    <div class="contenedor-opciones">
      <!-- ********************************************************************************************** -->
      <!-- CHECKBOX: ¿YA SE PURGÓ? -->
      <!-- ********************************************************************************************** -->
      <div class="checkbox-container anim-fade-in-up">
        <input
          type="checkbox"
          id="chkSorteado"
          style="width: 20px; height: 20px; cursor: pointer; accent-color: var(--color-acento-actual);"
          onchange="toggleOpciones()"
        />
        <label for="chkSorteado" class="checkbox-label">
          ¿Ya se purgó la plantilla?
        </label>
      </div>

      <!-- ********************************************************************************************** -->
      <!-- BOTÓN: IR A PURGA (Si no está sorteado) -->
      <!-- ********************************************************************************************** -->
      <div id="areaIrPurga" class="anim-fade-in-up" style="text-align: center;">
        <p style="margin-bottom: 1rem; color: var(--texto-secundario); font-size: var(--font-size-md);">
          Si no has purgado la plantilla, ve a la sección de Purga primero.
        </p>
        <button class="btn btn-verde btn-grande" onclick="irAPurga()">
          <span>IR A PURGA</span>
          <div class="btn-icono-circulo">
            <i data-lucide="arrow-right"></i>
          </div>
        </button>
      </div>

      <!-- ********************************************************************************************** -->
      <!-- ZONA DE INPUTS (PLANTILLA + NUEVO) -->
      <!-- ********************************************************************************************** -->
      <!-- NOTE FOR DUMMIES:
             Oculto por defecto hasta que se marque el checkbox.
        -->
      <div id="areaInputs" class="fila-inputs anim-fade-in-up oculto">
        <!-- INPUT OCULTO (PLANTILLA) -->
        <input
          type="file"
          id="fileTemplate"
          accept=".udatasmith,.xml"
          style="display: none"
          onchange="handleFileSelect('template', this)"
        />

        <!-- INPUT OCULTO (NUEVO) -->
        <input
          type="file"
          id="fileNew"
          accept=".udatasmith,.xml"
          style="display: none"
          onchange="handleFileSelect('new', this)"
        />

        <!-- ****************************************************************************************** -->
        <!-- GRUPO: ARCHIVO PLANTILLA -->
        <!-- ****************************************************************************************** -->
        <div class="grupo-archivo">
          <div class="titulo-con-numero">
            <span class="num-resaltado">01</span>
            <span class="texto-titulo">PLANTILLA</span>
          </div>

          <button
            class="btn btn-azul btn-grande"
            style="width: 220px"
            onclick="document.getElementById('fileTemplate').click()"
          >
            <span>EXAMINAR</span>
            <div class="btn-icono-circulo">
              <i data-lucide="file-check"></i>
            </div>
          </button>

          <!-- Nombre del archivo -->
          <span
            id="lblTemplate"
            style="
              font-size: 0.8rem;
              color: var(--texto-secundario);
              margin-top: 5px;
            "
          >
            Ningún archivo
          </span>
        </div>

        <!-- ****************************************************************************************** -->
        <!-- GRUPO: ARCHIVO NUEVO -->
        <!-- ****************************************************************************************** -->
        <div class="grupo-archivo">
          <div class="titulo-con-numero">
            <span class="num-resaltado">02</span>
            <span class="texto-titulo">NUEVO</span>
          </div>

          <button
            class="btn btn-azul btn-grande"
            style="width: 220px"
            onclick="document.getElementById('fileNew').click()"
          >
            <span>EXAMINAR</span>
            <div class="btn-icono-circulo">
              <i data-lucide="file-plus"></i>
            </div>
          </button>

          <span
            id="lblNew"
            style="
              font-size: 0.8rem;
              color: var(--texto-secundario);
              margin-top: 5px;
            "
          >
            Ningún archivo
          </span>
        </div>
      </div>

      <!-- ********************************************************************************************** -->
      <!-- BOTÓN PROCESAR -->
      <!-- ********************************************************************************************** -->
      <div
        id="areaProcesar"
        class="anim-fade-in-up delay-200"
        style="display: none; margin-top: 2rem;"
      >
        <button class="btn btn-azul btn-grande" onclick="procesarReemplazo()">
          <span>PROCESAR</span>
          <div class="btn-icono-circulo">
            <i data-lucide="play"></i>
          </div>
        </button>
      </div>
    </div>

    <!-- ************************************************************************************************ -->
    <!-- SCRIPTS DE LÓGICA -->
    <!-- ************************************************************************************************ -->

    <!-- NOTE FOR DUMMIES:
         - purga.js: Contiene window.Purga.run (Sort & Purge)
         - Reemplazar.js: Contiene window.Reemplazar.run (llama a Purga y luego Merge)
    -->
    <script src="../recursos/scripts/logica/purga.js"></script>
    <script src="../recursos/scripts/logica/Reemplazar.js"></script>

    <script>
      lucide.createIcons();

      let fileTemplate = null;
      let fileNew = null;

      function handleFileSelect(type, input) {
        if (input.files && input.files.length > 0) {
          if (type === "template") {
            fileTemplate = input.files[0];
            document.getElementById("lblTemplate").textContent =
              fileTemplate.name;
          } else {
            fileNew = input.files[0];
            document.getElementById("lblNew").textContent = fileNew.name;
          }
        }
      }

      function readFileAsText(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsText(file);
        });
      }

      function downloadText(text, filename) {
        const blob = new Blob([text], {
          type: "application/xml;charset=utf-8",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      /* **********************************************************************************************
       * procesarReemplazo()
       * **********************************************************************************************
       * NOTE FOR DUMMIES:
       * Flujo actualizado:
       * 1. Lee archivos.
       * 2. Llama a window.Reemplazar.run(xmlTemplate, xmlNew).
       *    (Internamente hace Sort -> Purge -> Merge).
       * 3. Descarga y muestra Log.
       */
      async function procesarReemplazo() {
        if (!fileTemplate || !fileNew) {
          alert("Por favor selecciona ambos archivos (Plantilla y Nuevo).");
          return;
        }

        try {
          // Leer 2 archivos al mismo tiempo
          const [xmlTemplate, xmlNew] = await Promise.all([
            readFileAsText(fileTemplate),
            readFileAsText(fileNew),
          ]);

          // API Global nueva
          const result = window.Reemplazar.run(xmlTemplate, xmlNew);
          const finalXml = result.xml;

          // Guardar datos para LOG
          sessionStorage.setItem("LOG_DATA_ORIGINAL", xmlTemplate);
          sessionStorage.setItem("LOG_DATA_UNSORTED", xmlNew);
          sessionStorage.setItem("LOG_DATA_PROCESSED", finalXml);

          // Descargar XML final
          const outName = "TRM_" + fileNew.name;
          downloadText(finalXml, outName);

          // Ir al LOG
          irALog();
        } catch (e) {
          console.error(e);
          alert("Error al procesar: " + e.message);
        }
      }

      function irALog() {
        window.parent.postMessage(
          {
            tipo: "NAVEGAR",
            ruta: "log.html?origen=reemplazar",
          },
          "*"
        );
      }

      function irAPurga() {
        window.parent.postMessage(
          {
            tipo: "NAVEGAR",
            ruta: "purga.html",
          },
          "*"
        );
      }

      function toggleOpciones() {
        const chk = document.getElementById("chkSorteado");
        const areaInputs = document.getElementById("areaInputs");
        const areaProcesar = document.getElementById("areaProcesar");
        const areaIrPurga = document.getElementById("areaIrPurga");

        if (chk.checked) {
          areaInputs.classList.remove("oculto");
          areaProcesar.style.display = "block";
          areaIrPurga.style.display = "none";
        } else {
          areaInputs.classList.add("oculto");
          areaProcesar.style.display = "none";
          areaIrPurga.style.display = "block";
        }
      }

      // **********************************************************************************************
      // EVENTO: Cambio de tema desde el index
      // **********************************************************************************************
      window.addEventListener("message", (event) => {
        if (event.data.tipo === "CAMBIO_TEMA") {
          if (event.data.tema === "claro") {
            document.body.classList.add("tema-claro");
          } else {
            document.body.classList.remove("tema-claro");
          }
        }
      });
    </script>
  </body>
</html>
