<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reemplazar - Sim Automation</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="../recursos/estilos/variables.css">
    <link rel="stylesheet" href="../recursos/estilos/base.css">
    <link rel="stylesheet" href="../recursos/estilos/componentes/contenedores.css">
    <link rel="stylesheet" href="../recursos/estilos/componentes/herramientas-botones.css">
    <link rel="stylesheet" href="../recursos/estilos/fondos.css">
    <link rel="stylesheet" href="../recursos/estilos/animaciones.css">
</head>
<body class="fondo-reemplazar anim-fade-in">

    <div class="contenedor-opciones">
        
        <!-- Pregunta Inicial -->
        <div class="checkbox-container anim-fade-in-up">
            <label class="checkbox-label">¿El archivo viene ya sorteado?</label>
            <input type="checkbox" id="chkSorteado" style="width: 20px; height: 20px; accent-color: var(--color-azul);" onchange="toggleOpciones()">
        </div>

        <!-- Inputs de Archivo -->
        <div id="areaInputs" class="fila-inputs oculto anim-fade-in-up delay-100">
            <input type="file" id="fileTemplate" accept=".udatasmith,.xml" style="display: none;" onchange="handleFileSelect('template', this)">
            <input type="file" id="fileNew" accept=".udatasmith,.xml" style="display: none;" onchange="handleFileSelect('new', this)">

            <!-- Plantilla -->
            <div class="grupo-archivo">
                <div class="titulo-con-numero">
                    <span class="num-resaltado">01</span>
                    <span class="texto-titulo">PLANTILLA</span>
                </div>
                <button class="btn btn-azul btn-grande" style="width: 220px;" onclick="document.getElementById('fileTemplate').click()">
                    <span>EXAMINAR</span>
                    <div class="btn-icono-circulo">
                        <i data-lucide="file-check"></i>
                    </div>
                </button>
                <span id="lblTemplate" style="font-size: 0.8rem; color: var(--texto-secundario); margin-top: 5px;">Ningún archivo</span>
            </div>

            <!-- Nuevo -->
            <div class="grupo-archivo">
                <div class="titulo-con-numero">
                    <span class="num-resaltado">02</span>
                    <span class="texto-titulo">NUEVO</span>
                </div>
                <button class="btn btn-azul btn-grande" style="width: 220px;" onclick="document.getElementById('fileNew').click()">
                    <span>EXAMINAR</span>
                    <div class="btn-icono-circulo">
                        <i data-lucide="file-plus"></i>
                    </div>
                </button>
                <span id="lblNew" style="font-size: 0.8rem; color: var(--texto-secundario); margin-top: 5px;">Ningún archivo</span>
            </div>
        </div>

        <!-- Botón Procesar -->
        <div id="areaProcesar" class="anim-fade-in-up delay-200" style="display: none;">
            <button class="btn btn-azul btn-grande" onclick="procesarReemplazo()">
                <span>PROCESAR</span>
                <div class="btn-icono-circulo">
                    <i data-lucide="play"></i>
                </div>
            </button>
        </div>

        <!-- Opción Ir a Purga (Si no está sorteado) -->
        <div id="areaIrPurga" class="anim-fade-in-up delay-100">
            <p style="color: var(--texto-secundario); margin-bottom: 1rem;">Si no tienes una plantilla ordenada, debes ir a Purga primero.</p>
            <button class="btn btn-outline btn-ir-purga" onclick="irAPurga()">
                Ir a Purga <i data-lucide="arrow-right" style="width: 16px; margin-left: 5px;"></i>
            </button>
        </div>

    </div>

    <!-- Scripts -->
    <script src="../recursos/scripts/logica/sort-purge.js"></script>
    <script src="../recursos/scripts/logica/sorting.js"></script>
    <script src="../recursos/scripts/logica/merge-pipeline.js"></script>

    <script>
        lucide.createIcons();

        let fileTemplate = null;
        let fileNew = null;

        function toggleOpciones() {
            const isChecked = document.getElementById('chkSorteado').checked;
            const areaInputs = document.getElementById('areaInputs');
            const areaIrPurga = document.getElementById('areaIrPurga');
            const areaProcesar = document.getElementById('areaProcesar');

            if (isChecked) {
                areaInputs.classList.remove('oculto');
                areaIrPurga.style.display = 'none';
                areaProcesar.style.display = 'block';
            } else {
                areaInputs.classList.add('oculto');
                areaIrPurga.style.display = 'block';
                areaProcesar.style.display = 'none';
                // Reset files
                fileTemplate = null;
                fileNew = null;
                document.getElementById('lblTemplate').textContent = 'Ningún archivo';
                document.getElementById('lblNew').textContent = 'Ningún archivo';
            }
        }

        function handleFileSelect(type, input) {
            if (input.files && input.files.length > 0) {
                if (type === 'template') {
                    fileTemplate = input.files[0];
                    document.getElementById('lblTemplate').textContent = fileTemplate.name;
                } else {
                    fileNew = input.files[0];
                    document.getElementById('lblNew').textContent = fileNew.name;
                }
            }
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        function downloadText(text, filename) {
            const blob = new Blob([text], { type: "application/xml;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function procesarReemplazo() {
            if (!fileTemplate || !fileNew) {
                alert("Por favor selecciona ambos archivos (Plantilla y Nuevo).");
                return;
            }

            try {
                const [xmlTemplate, xmlNew] = await Promise.all([
                    readFileAsText(fileTemplate),
                    readFileAsText(fileNew)
                ]);

                // 1. Ordenar el Nuevo basado en la Plantilla
                const xmlNewSorted = window.DatasmithSorter.sortNewBasedOnTemplate(xmlTemplate, xmlNew);

                // 2. Merge
                const result = window.DatasmithMerge.runMerge(xmlTemplate, xmlNewSorted);
                const finalXml = result.xml;

                // Guardar datos para el Log
                sessionStorage.setItem('LOG_DATA_ORIGINAL', xmlTemplate);
                sessionStorage.setItem('LOG_DATA_UNSORTED', xmlNew);
                sessionStorage.setItem('LOG_DATA_PROCESSED', finalXml);

                // Descargar
                const outName = "TRM_" + fileNew.name;
                downloadText(finalXml, outName);

                // Ir al Log
                irALog();

            } catch (e) {
                console.error(e);
                alert("Error al procesar: " + e.message);
            }
        }

        function irAPurga() {
            window.parent.postMessage({ tipo: 'NAVEGAR', ruta: 'purga.html' }, '*');
        }

        function irALog() {
            window.parent.postMessage({ tipo: 'NAVEGAR', ruta: 'log.html?origen=reemplazar' }, '*');
        }

        // Inicializar estado
        toggleOpciones();

        // Escuchar tema
        window.addEventListener('message', (event) => {
            if (event.data.tipo === 'CAMBIO_TEMA') {
                if (event.data.tema === 'claro') {
                    document.body.classList.add('tema-claro');
                } else {
                    document.body.classList.remove('tema-claro');
                }
            }
        });
    </script>
</body>
</html>
