<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log - Sim Automation</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="../recursos/estilos/variables.css">
    <link rel="stylesheet" href="../recursos/estilos/base.css">
    <link rel="stylesheet" href="../recursos/estilos/componentes/contenedores.css">
    <link rel="stylesheet" href="../recursos/estilos/componentes/herramientas-botones.css">
    <link rel="stylesheet" href="../recursos/estilos/fondos.css">
    <link rel="stylesheet" href="../recursos/estilos/animaciones.css">
    <link rel="stylesheet" href="../recursos/estilos/componentes/log.css">
</head>
<body class="fondo-log anim-fade-in">

    <div class="log-header anim-fade-in-up">
        <button class="btn-volver" onclick="volver()">
            <i data-lucide="arrow-left" style="width: 18px;"></i>
            VOLVER
        </button>
        <div class="titulo-contexto">
            LOG <span id="badge-contexto" class="indicador-contexto">GENERAL</span>
        </div>
    </div>

    <!-- Resumen de Cambios -->
    <div class="resumen-cambios anim-fade-in-up delay-50">
        <div class="card-stat" onclick="mostrarDetalles('modificados')">
            <span class="stat-number stat-modificados" id="count-mod">0</span>
            <span class="stat-label">Modificados</span>
        </div>
        <div class="card-stat" onclick="mostrarDetalles('eliminados')">
            <span class="stat-number stat-eliminados" id="count-del">0</span>
            <span class="stat-label">Líneas Eliminadas</span>
        </div>
    </div>

    <!-- Modal Detalles -->
    <div class="modal-overlay" id="modal-detalles">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-titulo">Detalles</h3>
                <button class="btn-cerrar" onclick="cerrarModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body" id="modal-body-content">
                <!-- Contenido dinámico -->
            </div>
        </div>
    </div>

    <!-- 3 Paneles -->
    <div class="contenedor-logs">
        <div class="panel-log anim-fade-in-up delay-100">
            <h3 class="titulo-panel">ORIGINAL (PLANTILLA)</h3>
            <div class="contenido-log" id="log-original">Cargando...</div>
        </div>
        <div class="panel-log anim-fade-in-up delay-200">
            <h3 class="titulo-panel">NUEVO (DESORDENADO)</h3>
            <div class="contenido-log" id="log-unsorted">Cargando...</div>
        </div>
        <div class="panel-log anim-fade-in-up delay-300">
            <h3 class="titulo-panel">PROCESADO (FINAL)</h3>
            <div class="contenido-log" id="log-processed">Cargando...</div>
        </div>
    </div>

    <script src="../recursos/scripts/logica/log-viewer.js"></script>

    <script>
        lucide.createIcons();

        // Params
        const params = new URLSearchParams(window.location.search);
        const origen = params.get('origen') || 'inicio';

        // Config UI
        const badge = document.getElementById('badge-contexto');
        
        if (origen === 'purga') {
            badge.textContent = 'PURGA';
            badge.style.backgroundColor = 'var(--color-verde)';
            document.body.style.setProperty('--color-acento-actual', 'var(--color-verde)');
        } else if (origen === 'reemplazar') {
            badge.textContent = 'REEMPLAZAR';
            badge.style.backgroundColor = 'var(--color-azul)';
            document.body.style.setProperty('--color-acento-actual', 'var(--color-azul)');
        }

        // Load Data
        let currentStats = null;
        const originalXml = sessionStorage.getItem('LOG_DATA_ORIGINAL');
        const unsortedXml = sessionStorage.getItem('LOG_DATA_UNSORTED');
        const processedXml = sessionStorage.getItem('LOG_DATA_PROCESSED');

        if (originalXml && processedXml) {
            // Render Diff (Original vs Processed)
            // Note: We pass unsortedXml just for display in the middle panel
            currentStats = window.LogViewer.render(originalXml, processedXml, unsortedXml);
            
            if (currentStats) {
                const modCount = currentStats.details.filter(d => d.type === 'MODIFICADO' || d.type === 'AGREGADO').length;
                document.getElementById('count-mod').textContent = modCount;
                document.getElementById('count-del').textContent = currentStats.removedLinesCount;
            }

            // Ocultar panel central si es Purga
            if (origen === 'purga') {
                const panelUnsorted = document.querySelector('.panel-log:nth-child(2)');
                if (panelUnsorted) panelUnsorted.style.display = 'none';
                
                // Ajustar grid para 2 columnas
                document.querySelector('.contenedor-logs').style.gridTemplateColumns = '1fr 1fr';
            }
        } else {
            document.getElementById('log-original').textContent = "No hay datos.";
            document.getElementById('log-unsorted').textContent = "No hay datos.";
            document.getElementById('log-processed').textContent = "No hay datos.";
        }

        // Modal Logic (Optimized)
        const modal = document.getElementById('modal-detalles');
        const modalBody = document.getElementById('modal-body-content');
        const tituloModal = document.getElementById('modal-titulo');

        function mostrarDetalles(tipo) {
            if (!currentStats) return;
            
            modalBody.innerHTML = ''; // Clear
            modal.classList.add('activo');

            let items = [];
            if (tipo === 'modificados') {
                tituloModal.textContent = 'ELEMENTOS MODIFICADOS / AGREGADOS';
                items = currentStats.details.filter(d => d.type === 'MODIFICADO' || d.type === 'AGREGADO');
            } else if (tipo === 'eliminados') {
                tituloModal.textContent = 'ELEMENTOS ELIMINADOS';
                items = currentStats.details.filter(d => d.type === 'ELIMINADO' || d.type === 'PARCIALMENTE_ELIMINADO');
            }

            if (items.length === 0) {
                modalBody.innerHTML = '<p style="text-align:center; opacity:0.5;">No hay elementos.</p>';
                return;
            }

            // Group by Tag
            const grouped = items.reduce((acc, item) => {
                const tag = item.tag || 'Otros';
                (acc[tag] = acc[tag] || []).push(item);
                return acc;
            }, {});

            const fragment = document.createDocumentFragment();
            const sortedTags = Object.keys(grouped).sort();

            sortedTags.forEach(tag => {
                const detailsEl = document.createElement('details');
                const summaryEl = document.createElement('summary');
                
                // Determine group type for description
                let groupDesc = "";
                if (tipo === 'modificados') groupDesc = "(Cambios detectados)";
                else groupDesc = "(Removidos)";

                summaryEl.textContent = `${tag} ${groupDesc} [${grouped[tag].length}]`;
                detailsEl.appendChild(summaryEl);

                const contentDiv = document.createElement('div');
                contentDiv.className = 'grupo-contenido';

                grouped[tag].forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'item-detalle';
                    
                    const infoDiv = document.createElement('div');
                    const nameStrong = document.createElement('strong');
                    nameStrong.textContent = item.name;
                    const descDiv = document.createElement('div');
                    descDiv.style.fontSize = '0.75em';
                    descDiv.style.opacity = '0.7';
                    descDiv.textContent = item.desc;

                    infoDiv.appendChild(nameStrong);
                    infoDiv.appendChild(descDiv);

                    const tagSpan = document.createElement('span');
                    let tagClass = '';
                    let labelTipo = item.type;
                    if (item.type === 'MODIFICADO') tagClass = 'tag-mod';
                    else if (item.type === 'AGREGADO') tagClass = 'tag-add';
                    else if (item.type === 'ELIMINADO') tagClass = 'tag-del';
                    else if (item.type === 'PARCIALMENTE_ELIMINADO') {
                        tagClass = 'tag-del';
                        labelTipo = 'ELIMINADO (PARCIAL)';
                    }
                    tagSpan.className = `tag-tipo ${tagClass}`;
                    tagSpan.textContent = labelTipo;

                    itemDiv.appendChild(infoDiv);
                    itemDiv.appendChild(tagSpan);
                    contentDiv.appendChild(itemDiv);
                });

                detailsEl.appendChild(contentDiv);
                fragment.appendChild(detailsEl);
            });

            requestAnimationFrame(() => {
                modalBody.appendChild(fragment);
            });
        }

        function cerrarModal() {
            modal.classList.remove('activo');
        }

        modal.addEventListener('click', (e) => {
            if (e.target === modal) cerrarModal();
        });

        window.addEventListener('message', (event) => {
            if (event.data.tipo === 'CAMBIO_TEMA') {
                if (event.data.tema === 'claro') {
                    document.body.classList.add('tema-claro');
                } else {
                    document.body.classList.remove('tema-claro');
                }
            }
        });

        function volver() {
            const rutaDestino = origen === 'inicio' ? 'inicio.html' : `${origen}.html`;
            window.parent.postMessage({ tipo: 'NAVEGAR', ruta: rutaDestino }, '*');
        }
    </script>
</body>
</html>
